

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Astronomical Image Reprojection &mdash; reprojection  documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="_static/graphviz.css?v=4ae1632d" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=5929fcd5"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
      <script async="async" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="API Reference" href="autoapi/index.html" />
    <link rel="prev" title="Welcome to reprojection’s documentation!" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            reprojection
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Astronomical Image Reprojection</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#mathematical-foundation">Mathematical Foundation</a></li>
<li class="toctree-l2"><a class="reference internal" href="#the-complete-transformation-pipeline">The Complete Transformation Pipeline</a></li>
<li class="toctree-l2"><a class="reference internal" href="#wcs-transformation-with-sip-distortion">WCS Transformation with SIP Distortion</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pixel-to-sky-transformation">Pixel to Sky Transformation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sky-to-pixel-transformation">Sky to Pixel Transformation</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#interpolation-methods">Interpolation Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="#gpu-acceleration">GPU Acceleration</a></li>
<li class="toctree-l2"><a class="reference internal" href="#implementation-details">Implementation Details</a></li>
<li class="toctree-l2"><a class="reference internal" href="#usage-example">Usage Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#limitations-and-future-work">Limitations and Future Work</a></li>
<li class="toctree-l2"><a class="reference internal" href="#references">References</a></li>
<li class="toctree-l2"><a class="reference internal" href="#note">Note</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="autoapi/index.html">API Reference</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">reprojection</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Astronomical Image Reprojection</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/solution_methodology.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="astronomical-image-reprojection">
<h1>Astronomical Image Reprojection<a class="headerlink" href="#astronomical-image-reprojection" title="Link to this heading"></a></h1>
<section id="mathematical-foundation">
<h2>Mathematical Foundation<a class="headerlink" href="#mathematical-foundation" title="Link to this heading"></a></h2>
<p>Astronomical image reprojection is the process of transforming an image from one World Coordinate System (WCS) to another. This involves converting pixel positions from one coordinate frame to another while preserving the underlying celestial coordinates. This document explains the mathematical principles and implementation details of our reprojection process.</p>
</section>
<section id="the-complete-transformation-pipeline">
<h2>The Complete Transformation Pipeline<a class="headerlink" href="#the-complete-transformation-pipeline" title="Link to this heading"></a></h2>
<p>The reprojection process follows these steps:</p>
<ol class="arabic simple">
<li><p>Calculate sky coordinates (RA/Dec) for each pixel in the target image</p></li>
<li><p>Convert these sky coordinates to pixel coordinates in the source image</p></li>
<li><p>Interpolate the source image at these calculated coordinates</p></li>
</ol>
<p>Each of these steps involves several mathematical transformations, which we’ll detail below.</p>
</section>
<section id="wcs-transformation-with-sip-distortion">
<h2>WCS Transformation with SIP Distortion<a class="headerlink" href="#wcs-transformation-with-sip-distortion" title="Link to this heading"></a></h2>
<p>Our implementation handles the FITS World Coordinate System (WCS) standard with Simple Imaging Polynomial (SIP) distortion correction. WCS with SIP defines a mapping between pixel coordinates and celestial coordinates.</p>
<section id="pixel-to-sky-transformation">
<h3>Pixel to Sky Transformation<a class="headerlink" href="#pixel-to-sky-transformation" title="Link to this heading"></a></h3>
<p>To convert from pixel coordinates (x, y) to sky coordinates (RA, Dec), we follow this process:</p>
<ol class="arabic">
<li><p><strong>Pixel Offset Calculation</strong></p>
<p>We first compute the offset from the reference pixel:</p>
<div class="math notranslate nohighlight">
\[\begin{split}u = x - \text{CRPIX1} \\
v = y - \text{CRPIX2}\end{split}\]</div>
<p>where CRPIX1 and CRPIX2 are the reference pixel coordinates.</p>
</li>
<li><p><strong>SIP Distortion Correction</strong></p>
<p>We apply the SIP distortion polynomials to account for optical distortion:</p>
<div class="math notranslate nohighlight">
\[\begin{split}x' = u + A(u, v) \\
y' = v + B(u, v)\end{split}\]</div>
<p>The SIP polynomials A and B are defined as:</p>
<p>For order 2:</p>
<div class="math notranslate nohighlight">
\[\begin{split}A(u, v) = A_{0,2} v^2 + A_{1,1} u v + A_{2,0} u^2 \\
B(u, v) = B_{0,2} v^2 + B_{1,1} u v + B_{2,0} u^2\end{split}\]</div>
<p>For order 3:</p>
<div class="math notranslate nohighlight">
\[\begin{split}A(u, v) &amp;= A_{0,2} v^2 + A_{0,3} v^3 + A_{1,1} u v + A_{1,2} u v^2 + A_{2,0} u^2 + A_{2,1} u^2 v + A_{3,0} u^3 \\
B(u, v) &amp;= B_{0,2} v^2 + B_{0,3} v^3 + B_{1,1} u v + B_{1,2} u v^2 + B_{2,0} u^2 + B_{2,1} u^2 v + B_{3,0} u^3\end{split}\]</div>
</li>
<li><p><strong>PC Matrix Transformation</strong></p>
<p>The distorted coordinates are transformed by the PC (Projection Coordinate) matrix:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{pmatrix} x'' \\ y'' \end{pmatrix} =
\begin{pmatrix} \text{PC1\_1} &amp; \text{PC1\_2} \\ \text{PC2\_1} &amp; \text{PC2\_2} \end{pmatrix}
\begin{pmatrix} x' \\ y' \end{pmatrix}\end{split}\]</div>
</li>
<li><p><strong>Scaling by CDELT</strong></p>
<p>The coordinates are scaled by the pixel scale factors:</p>
<div class="math notranslate nohighlight">
\[\begin{split}x''' = x'' \cdot \text{CDELT1} \\
y''' = y'' \cdot \text{CDELT2}\end{split}\]</div>
</li>
<li><p><strong>Projection onto the Celestial Sphere</strong></p>
<p>The intermediate coordinates are projected onto the celestial sphere using the gnomonic (tangent plane) projection:</p>
<div class="math notranslate nohighlight">
\[\begin{split}r &amp;= \sqrt{(x''')^2 + (y''')^2} \\
\theta &amp;= \arctan(r) \\
\phi &amp;= \arctan2(-x''', y''')\end{split}\]</div>
<p>The celestial coordinates are then:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\delta &amp;= \arcsin(\sin(\delta_0) \cos(\theta) + \cos(\delta_0) \sin(\theta) \cos(\phi)) \\
\alpha &amp;= \alpha_0 + \arctan2(\sin(\theta) \sin(\phi), \cos(\delta_0) \cos(\theta) - \sin(\delta_0) \sin(\theta) \cos(\phi))\end{split}\]</div>
<p>where <span class="math notranslate nohighlight">\(\alpha_0\)</span> and <span class="math notranslate nohighlight">\(\delta_0\)</span> are the reference RA and Dec (CRVAL1 and CRVAL2) in radians.</p>
</li>
</ol>
</section>
<section id="sky-to-pixel-transformation">
<h3>Sky to Pixel Transformation<a class="headerlink" href="#sky-to-pixel-transformation" title="Link to this heading"></a></h3>
<p>The inverse transformation from sky coordinates (RA, Dec) to pixel coordinates involves these steps:</p>
<ol class="arabic">
<li><p><strong>Compute Direction Cosines</strong></p>
<p>From sky coordinates, we compute the angular difference from the reference point:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\Delta\alpha &amp;= \alpha - \alpha_0 \\
\cos(\Delta\alpha) &amp;= \cos(\Delta\alpha) \\
\sin(\Delta\alpha) &amp;= \sin(\Delta\alpha)\end{split}\]</div>
<p>We ensure that <span class="math notranslate nohighlight">\(\Delta\alpha\)</span> is in the range <span class="math notranslate nohighlight">\([-\pi, \pi]\)</span> to handle the RA wrap-around.</p>
</li>
<li><p><strong>Compute Tangent Plane Coordinates</strong></p>
<p>We project onto the tangent plane:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\text{denom} &amp;= \sin(\delta_0) \sin(\delta) + \cos(\delta_0) \cos(\delta) \cos(\Delta\alpha) \\
x''' &amp;= -\cos(\delta) \sin(\Delta\alpha) / \text{denom} \\
y''' &amp;= (\sin(\delta) \cos(\delta_0) - \cos(\delta) \sin(\delta_0) \cos(\Delta\alpha)) / \text{denom}\end{split}\]</div>
<p>A small epsilon (e.g., 1e-10) is added to the denominator to ensure numerical stability.</p>
</li>
<li><p><strong>Scale by Inverse CDELT</strong></p>
<p>We scale by the inverse of the pixel scale factors:</p>
<div class="math notranslate nohighlight">
\[\begin{split}x'' &amp;= x''' / \text{CDELT1} \\
y'' &amp;= y''' / \text{CDELT2}\end{split}\]</div>
</li>
<li><p><strong>Apply Inverse PC Matrix</strong></p>
<p>We apply the inverse of the PC matrix:</p>
<div class="math notranslate nohighlight">
\[\begin{split}\begin{pmatrix} x' \\ y' \end{pmatrix} =
\begin{pmatrix} \text{PC1\_1} &amp; \text{PC1\_2} \\ \text{PC2\_1} &amp; \text{PC2\_2} \end{pmatrix}^{-1}
\begin{pmatrix} x'' \\ y'' \end{pmatrix}\end{split}\]</div>
</li>
<li><p><strong>Inverse SIP Distortion Correction</strong></p>
<p>We apply the inverse SIP distortion polynomials:</p>
<div class="math notranslate nohighlight">
\[\begin{split}x_{\text{undistorted}} &amp;= x' + AP(x', y') \\
y_{\text{undistorted}} &amp;= y' + BP(x', y')\end{split}\]</div>
<p>The inverse SIP polynomials AP and BP have similar forms to A and B but include constant and first-order terms:</p>
<p>For order 2:</p>
<div class="math notranslate nohighlight">
\[\begin{split}AP(x', y') &amp;= AP_{0,0} + AP_{0,1} y' + AP_{0,2} (y')^2 + AP_{1,0} x' + AP_{1,1} x' y' + AP_{2,0} (x')^2 \\
BP(x', y') &amp;= BP_{0,0} + BP_{0,1} y' + BP_{0,2} (y')^2 + BP_{1,0} x' + BP_{1,1} x' y' + BP_{2,0} (x')^2\end{split}\]</div>
<p>For order 3, additional higher-order terms are included.</p>
</li>
<li><p><strong>Add Reference Pixel</strong></p>
<p>Finally, we add the reference pixel coordinates to get the final pixel position:</p>
<div class="math notranslate nohighlight">
\[\begin{split}x &amp;= x_{\text{undistorted}} + \text{CRPIX1} \\
y &amp;= y_{\text{undistorted}} + \text{CRPIX2}\end{split}\]</div>
</li>
</ol>
</section>
</section>
<section id="interpolation-methods">
<h2>Interpolation Methods<a class="headerlink" href="#interpolation-methods" title="Link to this heading"></a></h2>
<p>Once we have the mapping from target pixels to source pixels, we need to interpolate the source image values. Our implementation supports three interpolation methods:</p>
<ol class="arabic">
<li><p><strong>Nearest Neighbor</strong></p>
<p>The simplest method, which takes the value of the nearest pixel:</p>
<div class="math notranslate nohighlight">
\[v(x,y) = v(\lfloor x + 0.5 \rfloor, \lfloor y + 0.5 \rfloor)\]</div>
<p>This method is fastest but produces blocky results.</p>
</li>
<li><p><strong>Bilinear Interpolation</strong></p>
<p>Uses the weighted average of the four nearest pixels:</p>
<div class="math notranslate nohighlight">
\[\begin{split}v(x,y) = &amp;v(x_0,y_0)(1-dx)(1-dy) + v(x_1,y_0)dx(1-dy) + \\
        &amp;v(x_0,y_1)(1-dx)dy + v(x_1,y_1)dxdy\end{split}\]</div>
<p>Where <span class="math notranslate nohighlight">\(dx = x - x_0\)</span> and <span class="math notranslate nohighlight">\(dy = y - y_0\)</span>.</p>
<p>This provides smoother results than nearest neighbor.</p>
</li>
<li><p><strong>Bicubic Interpolation</strong></p>
<p>Uses a 4×4 neighborhood of pixels with cubic weighting:</p>
<div class="math notranslate nohighlight">
\[v(x,y) = \sum_{i=0}^{3}\sum_{j=0}^{3} a_{ij} x^i y^j\]</div>
<p>This provides the highest quality results but is computationally more expensive.</p>
</li>
</ol>
</section>
<section id="gpu-acceleration">
<h2>GPU Acceleration<a class="headerlink" href="#gpu-acceleration" title="Link to this heading"></a></h2>
<p>Our implementation leverages PyTorch for GPU acceleration. The coordinate transformations and interpolation are performed on the GPU if available, providing significant speed improvements for large images.</p>
<p>The key components that benefit from GPU acceleration are:</p>
<ol class="arabic simple">
<li><p>Matrix operations (PC matrix transformation)</p></li>
<li><p>Polynomial evaluations (SIP distortion calculations)</p></li>
<li><p>Trigonometric functions (projection calculations)</p></li>
<li><p>Grid interpolation (using torch.nn.functional.grid_sample)</p></li>
</ol>
</section>
<section id="implementation-details">
<h2>Implementation Details<a class="headerlink" href="#implementation-details" title="Link to this heading"></a></h2>
<p>The reprojection process is implemented in the following classes:</p>
<ol class="arabic simple">
<li><p><strong>WCSHeader</strong>: Stores all WCS parameters and implements the SIP polynomial functions</p></li>
<li><p><strong>Reproject</strong>: Handles the coordinate transformations and interpolation</p></li>
</ol>
<p>The high-level API function <cite>calculate_reprojection</cite> provides a convenient interface for users, automatically handling device selection and data type conversions.</p>
</section>
<section id="usage-example">
<h2>Usage Example<a class="headerlink" href="#usage-example" title="Link to this heading"></a></h2>
<p>Here’s a complete example of reprojecting an image:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">astropy.io</span><span class="w"> </span><span class="kn">import</span> <span class="n">fits</span>
<span class="kn">from</span><span class="w"> </span><span class="nn">astroreproject</span><span class="w"> </span><span class="kn">import</span> <span class="n">calculate_reprojection</span>

<span class="c1"># Load source and target images</span>
<span class="n">source_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;source_image.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
<span class="n">target_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s1">&#39;target_grid.fits&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

<span class="c1"># Perform reprojection with bilinear interpolation</span>
<span class="n">reprojected</span> <span class="o">=</span> <span class="n">calculate_reprojection</span><span class="p">(</span>
    <span class="n">source_hdu</span><span class="o">=</span><span class="n">source_hdu</span><span class="p">,</span>
    <span class="n">target_hdu</span><span class="o">=</span><span class="n">target_hdu</span><span class="p">,</span>
    <span class="n">interpolation_mode</span><span class="o">=</span><span class="s1">&#39;bilinear&#39;</span>
<span class="p">)</span>

<span class="c1"># Convert back to NumPy and save as FITS</span>
<span class="n">reprojected_np</span> <span class="o">=</span> <span class="n">reprojected</span><span class="o">.</span><span class="n">cpu</span><span class="p">()</span><span class="o">.</span><span class="n">numpy</span><span class="p">()</span>
<span class="n">output_hdu</span> <span class="o">=</span> <span class="n">fits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">reprojected_np</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">target_hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
<span class="n">output_hdu</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="s1">&#39;reprojected_image.fits&#39;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="limitations-and-future-work">
<h2>Limitations and Future Work<a class="headerlink" href="#limitations-and-future-work" title="Link to this heading"></a></h2>
<p>The current implementation has some limitations:</p>
<ol class="arabic simple">
<li><p>Supports only gnomonic (TAN) projection with SIP distortion</p></li>
<li><p>Handles only 2D images (not data cubes)</p></li>
<li><p>Does not preserve flux in the strictest sense</p></li>
</ol>
<p>Future improvements could include:</p>
<ol class="arabic simple">
<li><p>Support for additional projection types (SIN, CAR, etc.)</p></li>
<li><p>Flux-conserving resampling methods</p></li>
<li><p>Uncertainty propagation</p></li>
<li><p>Support for masked pixels and NaN handling</p></li>
</ol>
</section>
<section id="references">
<h2>References<a class="headerlink" href="#references" title="Link to this heading"></a></h2>
<ol class="arabic simple">
<li><p>Calabretta, M. R., &amp; Greisen, E. W. (2002). Representations of celestial coordinates in FITS. Astronomy &amp; Astrophysics, 395(3), 1077-1122.</p></li>
<li><p>Shupe, D. L., et al. (2005). The SIP Convention for Representing Distortion in FITS Image Headers. Astronomical Data Analysis Software and Systems XIV, 347, 491.</p></li>
<li><p>Greisen, E. W., &amp; Calabretta, M. R. (2002). Representations of world coordinates in FITS. Astronomy &amp; Astrophysics, 395(3), 1061-1075.</p></li>
</ol>
</section>
<section id="note">
<h2>Note<a class="headerlink" href="#note" title="Link to this heading"></a></h2>
<p>Claude.ai was used in creating this page</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="Welcome to reprojection’s documentation!" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="autoapi/index.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Carter Rhea.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>